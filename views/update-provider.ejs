<!-- PROVIDER UPDATE FORM -->
<% layout('layout/boilerplate.ejs') -%>

<section>
    <h1 class="text-center my-4">Provider Details Form</h1>
    <hr style="all: revert; height: 1px; background-color: black">

    <div class="container">
        <form id='form' method="post" action="/provider/<%= userRoleID %>?_method=patch" class="card col-lg-10 py-5 mx-auto px-2 border-0 validation-required" novalidate>
            <div class="form-group row">
                <label for="name" class="col-4 col-form-label">Name</label>
                <div class="col-8">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <i class="fa fa-user-circle-o"></i>
                            </div>
                        </div>
                        <input id="name" name="name" placeholder="Name" type="text" class="form-control" required="required" value="<%= userInfo.name %>" readonly>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="email" class="col-4 col-form-label">Email</label>
                <div class="col-8">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <i class="fa fa-link"></i>
                            </div>
                        </div>
                        <input id="email" name="email" placeholder="Email" type="text" class="form-control" required="required" value="<%= userInfo.email %>" readonly>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="phone" class="col-4 col-form-label">Phone</label>
                <div class="col-8">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <i class="fa fa-phone"></i>
                            </div>
                        </div>
                        <input id="phone" name="phone" placeholder="Phone Number" type="text" class="form-control" required="required" pattern="(7|8|9)\d{9}" value="<%= userInfo.phone %>">
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="dob" class="col-4 col-form-label">Date of Birth</label>
                <div class="col-8">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <i class="fa fa-birthday-cake"></i>
                            </div>
                        </div>
                        <input id="dob" name="dob" type="date" min="1980-01-01"
                               max="<%= new Date(new Date().getFullYear() - 18, new Date().getMonth(), new Date().getDate()).toLocaleDateString('fr-ca') %>"
                               class="form-control" required="required" value="<%= userInfo.dob.toLocaleDateString('fr-ca') %>">
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="gst" class="col-4 col-form-label">GST</label>
                <div class="col-8">
                    <input id="gst" name="gst" placeholder="GST Number" type="text" class="form-control" aria-describedby="gstHelpBlock" pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}" value="<%= userInfo.gst %>" required>
                    <span id="gstHelpBlock" class="form-text text-muted">Provide correct GST number for validation.</span>
                </div>
            </div>

            <br>
            <h4>ADDRESS DETAILS</h4>
            <hr class="hr hr-blurry bg-black" />
            <div class="form-group row">
                <label for="addBuilding" class="col-4 col-form-label">Building Address</label>
                <div class="col-8">
                    <input id="addBuilding" name="addBuilding" placeholder="Building Address" type="text" class="form-control" required="required" value="<%= userInfo.address.building %>">
                </div>
            </div>
            <div class="form-group row">
                <label for="addL1" class="col-4 col-form-label">Address Line 1</label>
                <div class="col-8">
                    <input id="addL1" name="addL1" placeholder="Address Line 1" type="text" class="form-control" required="required" value="<%= userInfo.address.addL1 %>">
                </div>
            </div>
            <div class="form-group row">
                <label for="addL2" class="col-4 col-form-label">Address Line 2</label>
                <div class="col-8">
                    <input id="addL2" name="addL2" placeholder="Address Line 2" type="text" class="form-control" value="<%= userInfo.address.addL2 %>">
                </div>
            </div>
            <div class="form-group row">
                <label for="landmark" class="col-4 col-form-label">Landmark</label>
                <div class="col-8">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <i class="fa fa-map-marker"></i>
                            </div>
                        </div>
                        <input id="landmark" name="landmark" placeholder="Enter nearest landmark" type="text" class="form-control" required="required" value="<%= userInfo.address.landmark %>">
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="state" class="col-4 col-form-label">State</label>
                <div class="col-8">
                    <select id="state" name="state" type="text" class="form-control" required="required">
                        <option value="<%= user.state %>" selected><%= userInfo.address.state %></option>
                    </select>
                </div>
            </div>
            <div class="form-group row">
                <label for="city" class="col-4 col-form-label">City</label>
                <div class="col-8">
                    <select id="city" name="city" type="text" class="form-control" required="required">
                        <option value="<%= user.city %>"><%= userInfo.address.city %></option>
                    </select>
                </div>
            </div>
            <div class="form-group row">
                <label for="zipCode" class="col-4 col-form-label">Zip Code</label>
                <div class="col-8">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <i class="fa fa-location-arrow"></i>
                            </div>
                        </div>
                        <input id="zipCode" name="zipCode" placeholder="Zip Code" type="text" pattern="\d{6}" class="form-control" required="required" value="<%= userInfo.address.zipcode %>">
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <div class="offset-4 col-8">
                    <button name="submit" type="submit" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </form>
    </div>
</section>

<script>
	document.getElementById('city').setAttribute('disabled', 'true');

	async function fetchStates () {
		return await fetch('/state-list').then(function(response) {
			return response.json();
		}).then(function(data) {
			return data;
		});
	}

	fetchStates().then(data => {
		const stateSelector = document.getElementById('state');
		data.forEach(v => {
			const newOption = document.createElement('option');
			newOption.setAttribute('value', v);
			newOption.innerText = v;
			stateSelector.appendChild(newOption);
		});
	});

	document.getElementById('state').addEventListener('change', (e) => {
		const val = e.target.value;
		const citySelector = document.getElementById('city');

		if (val) {
			console.log('true')
			citySelector.removeAttribute('disabled');
			citySelector.innerText = '';
			fetch('/city/' + val).then(response => {
				return response.json()
			}).then(data => {
				data.forEach(v => {
					const newOption = document.createElement('option');
					newOption.setAttribute('value', v);
					newOption.innerText = v;
					citySelector.appendChild(newOption);
				});
			});
		}
		else {
			citySelector.innerText = '';
			citySelector.setAttribute('disabled', 'true');
		}
	});

	const form = document.getElementById('form');

	form.addEventListener('submit', e => {
		e.preventDefault();

		if (!form.checkValidity())
			return;

		const url = '/provider/<%= userRoleID %>?_method=patch';
		const formData = new URLSearchParams(new FormData(form));

		const config = {
			url: url,
			method: 'post',
			headers: {
				'Content-Type': 'application/x-www-form-urlencoded',
			},
			data: formData.toString(),
		};

		axios(config)
			.then((response) => {
				addFlash('success', 'Your data has been successfully updated!');
				setTimeout(() => {
					window.location = '/provider/<%= userRoleID %>';
				}, 2000);
			})
			.catch((error) => {
				const errors = error.response.data.errors;
				for (let err of errors)
					addFlash ('error', err.msg);
			});
    });
</script>